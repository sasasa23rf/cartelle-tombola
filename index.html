<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tombola Manager</title>
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --accent-color: #e74c3c;
            --highlight-color: #27ae60;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .container {
            width: 95%;
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Setup Screen */
        #setup-screen {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        input[type="number"] {
            padding: 10px;
            font-size: 1.2rem;
            width: 80px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:active {
            transform: scale(0.98);
        }

        /* Game Screen */
        #game-screen {
            display: none;
            width: 100%;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            position: sticky;
            top: 70px; /* Below header */
            background: var(--bg-color);
            padding: 10px;
            z-index: 90;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #extracted-number {
            width: 80px;
            font-size: 1.2rem;
            padding: 8px;
            text-align: center;
        }

        /* Tombola Card Styling */
        .tombola-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.3s ease, order 0.3s ease;
        }

        .card-header {
            background: #34495e;
            color: white;
            padding: 5px 10px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .match-count {
            background: var(--accent-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 1px;
            background-color: #ccc; /* Grid lines */
            border: 1px solid #ccc;
        }

        .cell {
            background-color: var(--card-bg);
            aspect-ratio: 1; /* Keep cells square-ish */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            position: relative;
        }

        .cell.empty {
            background-color: #f8f9fa;
        }

        .cell.marked {
            background-color: var(--highlight-color);
            color: white;
            animation: pop 0.3s ease;
        }

        /* Mobile Optimization */
        @media (max-width: 400px) {
            .cell {
                font-size: 0.9rem;
            }
            .container {
                width: 100%;
                padding: 0.5rem;
            }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        #history {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

<header>
    <h1>Tombola da Gessica</h1>
</header>

<div class="container">
    <!-- Setup Screen -->
    <div id="setup-screen">
        <h2>Impostazioni</h2>
        <p>Quante cartelle vuoi generare?</p>
        <input type="number" id="card-count" min="1" max="10" value="1">
        <br><br>
        <button onclick="startGame()">Genera Cartelle</button>
    </div>

    <!-- Game Screen -->
    <div id="game-screen">
        <div class="controls">
            <input type="number" id="input-number" placeholder="#" min="1" max="90">
            <button id="btn-insert" onclick="extractNumber()">Inserisci</button>
        </div>
        <div id="history">Numeri usciti: <span id="extracted-list"></span></div>
        <div id="cards-container"></div>
    </div>
    
    <footer style="margin-top: auto; padding: 20px; text-align: center; color: #7f8c8d; font-size: 0.8rem; border-top: 1px solid #ddd; width: 100%;">
        <p style="margin: 0;">App creata da Salvatore Costantino</p>
        <p style="margin: 5px 0 0 0;">Ogni diritto è riservato</p>
        <button id="fullscreen-btn" onclick="toggleFullScreen()" style="margin-top: 15px; background: transparent; color: #7f8c8d; border: 1px solid #ccc; padding: 5px 10px; font-size: 0.75rem;">
            ⛶ Schermo Intero
        </button>
    </footer>
</div>

<script>
    function toggleFullScreen() {
        const doc = document.documentElement;
        const btn = document.getElementById('fullscreen-btn');
        
        if (!document.fullscreenElement) {
            if (doc.requestFullscreen) {
                doc.requestFullscreen();
            } else if (doc.mozRequestFullScreen) { // Firefox
                doc.mozRequestFullScreen();
            } else if (doc.webkitRequestFullscreen) { // Chrome, Safari and Opera
                doc.webkitRequestFullscreen();
            } else if (doc.msRequestFullscreen) { // IE/Edge
                doc.msRequestFullscreen();
            }
            
            if (btn) btn.style.display = 'none';
        }
    }
    
    // Listen for fullscreen change to show button again if user exits manually
    document.addEventListener('fullscreenchange', (event) => {
        const btn = document.getElementById('fullscreen-btn');
        if (!document.fullscreenElement && btn) {
            btn.style.display = 'inline-block';
        }
    });

    // Game State
    let cards = []; // Array of card objects: { id, grid: [3][9], matches: 0 }
    let extractedNumbers = new Set();

    // Setup Logic
    function startGame() {
        const countInput = document.getElementById('card-count');
        let count = parseInt(countInput.value);

        if (isNaN(count) || count < 1) count = 1;

        cards = [];
        extractedNumbers = new Set();
        document.getElementById('extracted-list').textContent = '';
        
        // Generate Cards
        for (let i = 0; i < count; i++) {
            cards.push(generateCard(i + 1));
        }

        // Switch Views
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        
        renderCards();
    }

    function resetGame() {
        if(confirm("Vuoi davvero ricominciare?")) {
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'block';
            document.getElementById('input-number').value = '';
        }
    }

    // Card Generation Logic
    function generateCard(id) {
        // A Tombola card has 3 rows, 9 columns.
        // Each row has exactly 5 numbers.
        // Columns have specific ranges: 0:1-9, 1:10-19, ... 8:80-90
        
        let grid = Array(3).fill(null).map(() => Array(9).fill(0));
        
        // 1. Determine which columns contain numbers for each row to ensure 5 numbers per row
        // We need to ensure we don't violate column constraints (usually max 3 per column, but naturally handled by 3 rows)
        // More importantly, we want to avoid empty columns if possible, but randomness is key.
        
        // Simple approach:
        // For each row, pick 5 unique random column indices.
        // To improve distribution, we can try to balance, but pure random per row is standard for "random cards".
        
        // We need to track how many numbers are in each column across the 3 rows
        // to assign values later.
        
        let colCounts = Array(9).fill(0);
        
        for (let row = 0; row < 3; row++) {
            let availableCols = [0, 1, 2, 3, 4, 5, 6, 7, 8];
            
            // Heuristic: If a column has 0 numbers so far and we are at the last row, 
            // maybe prefer it? Standard tombola allows empty columns though.
            // Let's stick to pure random 5 selections per row first.
            
            // Shuffle availableCols
            for (let i = availableCols.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableCols[i], availableCols[j]] = [availableCols[j], availableCols[i]];
            }
            
            // Pick first 5
            for (let k = 0; k < 5; k++) {
                let colIndex = availableCols[k];
                grid[row][colIndex] = -1; // Placeholder
                colCounts[colIndex]++;
            }
        }
        
        // 2. Assign actual numbers
        // For each column, generate 'n' unique numbers within its range.
        for (let c = 0; c < 9; c++) {
            let count = colCounts[c];
            if (count === 0) continue;
            
            let min = c * 10;
            let max = c * 10 + 9;
            if (c === 0) min = 1;
            if (c === 8) max = 90;
            
            // Generate pool of numbers for this column
            let pool = [];
            for (let n = min; n <= max; n++) pool.push(n);
            
            // Pick 'count' random numbers from pool
            let picked = [];
            for (let k = 0; k < count; k++) {
                let idx = Math.floor(Math.random() * pool.length);
                picked.push(pool[idx]);
                pool.splice(idx, 1);
            }
            
            // Sort them ascending (required by Tombola rules)
            picked.sort((a, b) => a - b);
            
            // Place them into the grid from top to bottom
            let pickIdx = 0;
            for (let r = 0; r < 3; r++) {
                if (grid[r][c] === -1) {
                    grid[r][c] = picked[pickIdx++];
                }
            }
        }
        
        return {
            id: id,
            grid: grid,
            matches: 0
        };
    }

    // Game Logic
    function extractNumber() {
        const input = document.getElementById('input-number');
        const btn = document.getElementById('btn-insert');
        const num = parseInt(input.value);

        if (isNaN(num) || num < 1 || num > 90) {
            alert("Inserisci un numero valido da 1 a 90");
            return;
        }

        if (extractedNumbers.has(num)) {
            alert("Numero già inserito!");
            input.value = '';
            return;
        }

        extractedNumbers.add(num);
        updateHistory();
        checkMatches(num);
        
        input.value = '';
        input.blur(); // Close keyboard
        
        // Visual feedback
        if (btn) {
            btn.style.backgroundColor = '#27ae60'; // Green
            setTimeout(() => {
                btn.style.backgroundColor = ''; // Revert to CSS default
            }, 1000);
        }
    }
    
    // Allow pressing Enter to submit
    document.getElementById('input-number').addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            extractNumber();
        }
    });

    function updateHistory() {
        const list = Array.from(extractedNumbers).join(', ');
        document.getElementById('extracted-list').textContent = list;
    }

    function checkMatches(num) {
        let anyMatch = false;

        cards.forEach(card => {
            // Check grid
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 9; c++) {
                    if (card.grid[r][c] === num) {
                        card.matches++;
                        anyMatch = true;
                    }
                }
            }
        });

        // Sort cards: Most matches first
        cards.sort((a, b) => b.matches - a.matches);

        renderCards();
    }

    function renderCards() {
        const container = document.getElementById('cards-container');
        container.innerHTML = '';

        cards.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = 'tombola-card';
            
            // Header
            const header = document.createElement('div');
            header.className = 'card-header';
            const missing = card.matches - 15;
            header.innerHTML = `
                <span>Cartella #${card.id}</span>
                <span class="match-count">Tombola: ${missing}</span>
            `;
            cardEl.appendChild(header);

            // Grid
            const gridEl = document.createElement('div');
            gridEl.className = 'card-grid';

            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 9; c++) {
                    const cellVal = card.grid[r][c];
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    if (cellVal === 0) {
                        cell.classList.add('empty');
                    } else {
                        cell.textContent = cellVal;
                        if (extractedNumbers.has(cellVal)) {
                            cell.classList.add('marked');
                        }
                    }
                    gridEl.appendChild(cell);
                }
            }
            cardEl.appendChild(gridEl);
            container.appendChild(cardEl);
        });
    }
</script>

</body>
</html>
